<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Tracking V2 - Debug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .step-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .step-info h3 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .step-info ul {
            color: #6c757d;
            margin-left: 20px;
        }

        .step-info li {
            margin-bottom: 8px;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #videoPlayer {
            width: 100%;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .completion-code {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .debug-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-family: inherit;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                max-width: none;
            }
            
            .header {
                padding: 20px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Emotion Tracking Study</h1>
            <p>Help us understand emotional responses to video content</p>
            <p><strong>DEBUG VERSION</strong></p>
        </div>

        <!-- Step 1: Camera Access -->
        <div class="content">
            <div id="step1" class="step active">
                <h2>Step 1: Camera Access</h2>
                <div class="step-info">
                    <h3>Before we begin:</h3>
                    <ul>
                        <li>We need access to your camera to track your facial expressions</li>
                        <li>Your video data is processed locally and not stored</li>
                        <li>Only anonymous emotion data is collected</li>
                        <li>The study takes approximately 24 seconds</li>
                    </ul>
                </div>
                <button id="allowCameraBtn" class="btn">Allow Camera Access</button>
            </div>

            <!-- Step 2: Setup -->
            <div id="step2" class="step">
                <h2>Step 2: Video Setup</h2>
                <div class="step-info">
                    <h3>Setup Instructions:</h3>
                    <ul>
                        <li>Make sure you are in a well-lit area</li>
                        <li>Position your face clearly in front of the camera</li>
                        <li>The video will play automatically in fullscreen</li>
                        <li>Please watch the entire video without interruption</li>
                    </ul>
                </div>
                <button id="startVideoBtn" class="btn">Start Video</button>
            </div>

            <!-- Step 3: Video Playback -->
            <div id="step3" class="step">
                <h2>Step 3: Video Playback</h2>
                <video id="videoPlayer" playsinline muted>
                    <source id="videoSource" src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="step-info">
                    <p>Please watch the video and keep your face visible to the camera.</p>
                    <div id="videoInfo" style="font-size: 12px; color: #666;"></div>
                </div>
            </div>

            <!-- Step 4: Processing -->
            <div id="step4" class="step">
                <h2>Step 4: Processing Data</h2>
                <div class="step-info">
                    <p>Processing your emotion data...</p>
                    <div id="processingProgress">
                        <div id="progressFill" style="width: 0%; height: 4px; background: #4CAF50; border-radius: 2px; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Completion -->
            <div id="step5" class="step">
                <h2>Step 5: Complete</h2>
                <div class="completion-code">
                    <div>Your completion code:</div>
                    <div id="completionCode"></div>
                </div>
                <button id="copyCodeBtn" class="btn">Copy Code</button>
            </div>

            <!-- Error Display -->
            <div id="errorDisplay" class="error"></div>

            <!-- Debug Information -->
            <div class="debug-info">
                <h4>Debug Information:</h4>
                <div id="debugLog">Initializing...</div>
            </div>

            <!-- Debug Controls -->
            <button id="debugVideoBtn" class="btn" style="background: #2196F3;">Debug: Test Video Only</button>
            
            <!-- Retry Button -->
            <button id="retryBtn" class="btn" style="display: none; background: #ff9800;">Try Again</button>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://ai-sdk.morphcast.com/v1.16/ai-sdk.js?v3"></script>

    <!-- Configuration -->
    <script>
        console.log('üîß Loading Emotion Tracking V2 Configuration...');

        const config = {
            // Video Configuration
            VIDEO_URL: "https://assets.homa-cloud.com/cm0wqgm1d002gdslcdl3hq3yl/f4bea092-1f69-4f99-8d7a-fc8fb52ac610/CAY_R91_V1_WW_VID_1080x1920_24s.mp4",
            
            // Task Configuration
            TASK_ID: "TASK-DEBUG",
            COMPLETION_CODE: "DEBUG123",
            PRIVACY_POLICY_URL: "https://example.com/privacy",
            
            // Supabase Configuration
            SUPABASE_URL: "https://xpzyupzfgzfvmjttfqcs.supabase.co",
            SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhwenl1cHpmZ3pmdm1qdHRmcWNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjc3NzEyNzMsImV4cCI6MjA0MzM0NzI3M30.6hGJjRPnG1pGH8dZCkfgTOWa5O2WfUJFSKjOiZGJZZU",
            
            // Morphcast Configuration
            MORPHCAST_LICENSE: "ap95c1923492e8512306644ca7fea0e66e7c27a47b97bb",
            
            // Timeline Configuration (in seconds)
            TIMELINE_DURATION: 30,
            TIMELINE_INTERVAL: 1,
            
            // Debug Configuration
            DEBUG_MODE: true,
            CONSOLE_LOGGING: true
        };

        console.log('‚úÖ Configuration loaded successfully:', config);
        console.log('üìπ Video URL:', config.VIDEO_URL);
        console.log('üîë Morphcast License:', config.MORPHCAST_LICENSE ? 'Present' : 'Missing');
        console.log('üíæ Supabase URL:', config.SUPABASE_URL ? 'Present' : 'Missing');
    </script>

    <!-- Main Application -->
    <script>
        console.log('üöÄ Starting Emotion Tracker V2...');

        class EmotionTracker {
            constructor() {
                console.log('üéØ Initializing EmotionTracker class...');
                this.supabaseClient = null;
                this.morphcastInstance = null;
                this.trackingData = [];
                this.currentStep = 1;
                this.videoPlayer = null;
                this.progressFill = null;
                this.isTracking = false;
                this.startTime = null;
                
                console.log('üîÑ Starting initialization...');
                this.init();
            }

            init() {
                console.log('üîß Initializing Emotion Tracker components...');
                
                try {
                    // Initialize Supabase client
                    console.log('üíæ Initializing Supabase client...');
                    if (typeof supabase !== 'undefined') {
                        const { createClient } = supabase;
                        this.supabaseClient = createClient(config.SUPABASE_URL, config.SUPABASE_KEY);
                        console.log('‚úÖ Supabase client initialized');
                        this.updateDebugLog('‚úÖ Supabase client initialized');
                    } else {
                        console.error('‚ùå Supabase library not loaded');
                        this.updateDebugLog('‚ùå Supabase library not loaded');
                    }
                    
                    // Get DOM elements
                    console.log('üé® Getting DOM elements...');
                    this.videoPlayer = document.getElementById('videoPlayer');
                    this.progressFill = document.getElementById('progressFill');
                    
                    if (!this.videoPlayer) {
                        console.error('‚ùå Video player element not found');
                        this.updateDebugLog('‚ùå Video player element not found');
                    } else {
                        console.log('‚úÖ Video player element found');
                        this.updateDebugLog('‚úÖ Video player element found');
                    }
                    
                    // Set up event listeners
                    console.log('üëÇ Setting up event listeners...');
                    this.setupEventListeners();
                    
                    // Initialize Morphcast
                    console.log('üß† Initializing Morphcast...');
                    this.initializeMorphcast();
                    
                    // Set replaceable content
                    console.log('üîÑ Setting up replaceable content...');
                    this.setupReplacableContent();
                    
                    console.log('‚úÖ Emotion Tracker initialization complete');
                    this.updateDebugLog('‚úÖ Emotion Tracker initialization complete');
                    
                } catch (error) {
                    console.error('‚ùå Error during initialization:', error);
                    this.updateDebugLog('‚ùå Error during initialization: ' + error.message);
                }
            }

            updateDebugLog(message) {
                const debugLog = document.getElementById('debugLog');
                if (debugLog) {
                    debugLog.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }

            setupEventListeners() {
                console.log('üéØ Setting up event listeners...');
                
                // Camera permission button
                const allowCameraBtn = document.getElementById('allowCameraBtn');
                if (allowCameraBtn) {
                    console.log('‚úÖ Allow camera button found, adding click listener');
                    this.updateDebugLog('‚úÖ Allow camera button found');
                    allowCameraBtn.addEventListener('click', () => {
                        console.log('üé¨ Camera permission button clicked');
                        this.updateDebugLog('üé¨ Camera permission button clicked');
                        this.requestCameraAccess();
                    });
                } else {
                    console.error('‚ùå Allow camera button not found');
                    this.updateDebugLog('‚ùå Allow camera button not found');
                }

                // Start video button
                const startVideoBtn = document.getElementById('startVideoBtn');
                if (startVideoBtn) {
                    console.log('‚úÖ Start video button found');
                    this.updateDebugLog('‚úÖ Start video button found');
                    startVideoBtn.addEventListener('click', () => {
                        console.log('‚ñ∂Ô∏è Start video button clicked');
                        this.updateDebugLog('‚ñ∂Ô∏è Start video button clicked');
                        this.startVideo();
                    });
                } else {
                    console.error('‚ùå Start video button not found');
                    this.updateDebugLog('‚ùå Start video button not found');
                }

                // Copy code button
                const copyCodeBtn = document.getElementById('copyCodeBtn');
                if (copyCodeBtn) {
                    copyCodeBtn.addEventListener('click', () => {
                        console.log('üìã Copy code button clicked');
                        this.updateDebugLog('üìã Copy code button clicked');
                        this.copyCompletionCode();
                    });
                }

                // Debug video button
                const debugVideoBtn = document.getElementById('debugVideoBtn');
                if (debugVideoBtn) {
                    debugVideoBtn.addEventListener('click', () => {
                        console.log('üî¨ Debug video button clicked');
                        this.updateDebugLog('üî¨ Debug video button clicked');
                        this.testVideoOnly();
                    });
                }

                // Retry button
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', () => {
                        console.log('üîÑ Retry button clicked');
                        this.updateDebugLog('üîÑ Retry button clicked');
                        this.retry();
                    });
                }
            }

            setupReplacableContent() {
                // Set video source
                const videoSource = document.getElementById('videoSource');
                if (videoSource && config.VIDEO_URL) {
                    videoSource.src = config.VIDEO_URL;
                    console.log('üìπ Video source set to:', config.VIDEO_URL);
                    this.updateDebugLog('üìπ Video source set');
                    
                    // Add video load event listeners
                    this.videoPlayer.addEventListener('loadeddata', () => {
                        console.log('üìä Video data loaded');
                        this.updateDebugLog('üìä Video data loaded');
                    });
                    
                    this.videoPlayer.addEventListener('loadedmetadata', () => {
                        console.log('üìã Video metadata loaded');
                        this.updateDebugLog(`üìã Video metadata loaded (${this.videoPlayer.duration.toFixed(1)}s)`);
                        
                        // Update video info display
                        const videoInfo = document.getElementById('videoInfo');
                        if (videoInfo) {
                            videoInfo.innerHTML = `
                                Duration: ${this.videoPlayer.duration.toFixed(1)}s | 
                                Ready State: ${this.videoPlayer.readyState} | 
                                Network State: ${this.videoPlayer.networkState}
                            `;
                        }
                    });
                    
                    this.videoPlayer.addEventListener('canplay', () => {
                        console.log('‚úÖ Video can play');
                        this.updateDebugLog('‚úÖ Video can play');
                    });
                    
                    this.videoPlayer.addEventListener('error', (e) => {
                        console.error('‚ùå Video load error:', e);
                        this.updateDebugLog('‚ùå Video load error: ' + (this.videoPlayer.error?.message || 'Unknown'));
                    });
                    
                    // Force video to reload
                    this.videoPlayer.load();
                }

                // Set completion code
                const completionCodeElement = document.getElementById('completionCode');
                if (completionCodeElement) {
                    completionCodeElement.textContent = config.COMPLETION_CODE;
                }
            }

            async requestCameraAccess() {
                console.log('üé¨ Starting camera access request...');
                this.updateDebugLog('üé¨ Starting camera access request...');
                
                try {
                    // Check if getUserMedia is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('‚ùå getUserMedia is not supported in this browser');
                        this.updateDebugLog('‚ùå getUserMedia not supported');
                        this.showError('Your browser does not support camera access. Please use a modern browser.');
                        return;
                    }
                    
                    console.log('üîç Requesting camera permission...');
                    this.updateDebugLog('üîç Requesting camera permission...');
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    console.log('‚úÖ Camera permission granted');
                    this.updateDebugLog('‚úÖ Camera permission granted');
                    
                    // Stop the stream immediately as we only needed permission
                    stream.getTracks().forEach(track => {
                        console.log('üõë Stopping camera track:', track.kind);
                        track.stop();
                    });
                    
                    console.log('‚û°Ô∏è Moving to step 2...');
                    this.updateDebugLog('‚û°Ô∏è Moving to step 2...');
                    this.showStep(2);
                    
                } catch (error) {
                    console.error('‚ùå Camera access denied:', error);
                    this.updateDebugLog('‚ùå Camera access denied: ' + error.name);
                    
                    let errorMessage = 'Camera access is required for this study. Please allow camera access and try again.';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'Camera access was denied. Please click the camera icon in your browser address bar and allow camera access.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'No camera found. Please make sure you have a camera connected.';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage = 'Camera is already in use by another application.';
                    }
                    
                    this.showError(errorMessage);
                }
            }

            async initializeMorphcast() {
                try {
                    console.log('üß† Initializing Morphcast...');
                    console.log('üîë License key present:', config.MORPHCAST_LICENSE ? 'YES' : 'NO');
                    console.log('üèóÔ∏è SDK available:', typeof CY !== 'undefined' ? 'YES' : 'NO');
                    this.updateDebugLog('üß† Initializing Morphcast...');
                    this.updateDebugLog('üîë License: ' + (config.MORPHCAST_LICENSE ? 'Present' : 'Missing'));
                    this.updateDebugLog('üèóÔ∏è SDK: ' + (typeof CY !== 'undefined' ? 'Available' : 'Missing'));
                    
                    if (!config.MORPHCAST_LICENSE) {
                        console.error('‚ùå Morphcast license key not configured');
                        this.updateDebugLog('‚ùå No license key');
                        throw new Error('Morphcast license key not configured');
                    }

                    // Check if CY (Morphcast) is available
                    if (typeof CY === 'undefined') {
                        console.error('‚ùå Morphcast SDK not loaded - CY is undefined');
                        this.updateDebugLog('‚ùå SDK not loaded');
                        console.log('üîç Available globals:', Object.keys(window).filter(key => key.includes('CY') || key.includes('morphcast')));
                        throw new Error('Morphcast SDK not loaded');
                    }

                    const morphcastLoader = CY.loader()
                        .licenseKey(config.MORPHCAST_LICENSE)
                        .addModule(CY.modules().FACE_AROUSAL_VALENCE.name, { smoothness: 0.70 })
                        .addModule(CY.modules().FACE_EMOTION.name, { smoothness: 0.40 })
                        .addModule(CY.modules().FACE_ATTENTION.name, { smoothness: 0.83 })
                        .addModule(CY.modules().FACE_DETECTOR.name, { maxInputFrameSize: 320, smoothness: 0.83 })
                        .addModule(CY.modules().ALARM_NO_FACE.name, { timeWindowMs: 10000, initialToleranceMs: 7000, threshold: 0.75 })
                        .addModule(CY.modules().DATA_AGGREGATOR.name, { initialWaitMs: 2000, periodMs: 1000 });

                    console.log('üì¶ Loading Morphcast modules...');
                    this.updateDebugLog('üì¶ Loading modules...');
                    const { start, stop } = await morphcastLoader.load();
                    this.morphcastInstance = { start, stop };
                    
                    console.log('‚úÖ Morphcast initialized successfully');
                    this.updateDebugLog('‚úÖ Morphcast initialized');
                    
                } catch (error) {
                    console.error('‚ùå Morphcast initialization failed:', error);
                    this.updateDebugLog('‚ùå Morphcast failed: ' + error.message);
                    this.showError('Failed to initialize emotion tracking. Please check your license key and try again.');
                }
            }

            async startVideo() {
                try {
                    console.log('‚ñ∂Ô∏è Starting video...');
                    this.updateDebugLog('‚ñ∂Ô∏è Starting video...');
                    this.showStep(3);
                    
                    // Show video and start tracking
                    this.videoPlayer.style.display = 'block';
                    this.isTracking = true;
                    this.startTime = Date.now();
                    
                    // Add video event listeners for debugging
                    this.setupVideoEventListeners();
                    
                    // Start Morphcast tracking
                    if (this.morphcastInstance) {
                        console.log('üß† Starting Morphcast tracking...');
                        this.updateDebugLog('üß† Starting tracking...');
                        await this.morphcastInstance.start();
                    }
                    
                    // Start video playback
                    console.log('üé¨ Starting video playback...');
                    this.updateDebugLog('üé¨ Starting playback...');
                    
                    // Try to play the video
                    const playPromise = this.videoPlayer.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        console.log('‚úÖ Video started playing successfully');
                        this.updateDebugLog('‚úÖ Video started playing successfully');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error starting video:', error);
                    this.updateDebugLog('‚ùå Video start error: ' + error.message);
                    this.showError('Failed to start video. Please try again.');
                }
            }

            setupVideoEventListeners() {
                if (!this.videoPlayer) return;

                // Play event
                this.videoPlayer.addEventListener('play', () => {
                    console.log('üé¨ Video play event fired');
                    this.updateDebugLog('üé¨ Video play event fired');
                });

                // Pause event
                this.videoPlayer.addEventListener('pause', () => {
                    console.log('‚è∏Ô∏è Video pause event fired');
                    this.updateDebugLog('‚è∏Ô∏è Video pause event fired');
                });

                // Ended event
                this.videoPlayer.addEventListener('ended', () => {
                    console.log('üèÅ Video ended event fired');
                    this.updateDebugLog('üèÅ Video ended');
                    this.onVideoEnded();
                });

                // Error event
                this.videoPlayer.addEventListener('error', (e) => {
                    console.error('‚ùå Video error event:', e);
                    this.updateDebugLog('‚ùå Video error: ' + (this.videoPlayer.error?.message || 'Unknown error'));
                });

                // Stalled event
                this.videoPlayer.addEventListener('stalled', () => {
                    console.log('‚è≥ Video stalled');
                    this.updateDebugLog('‚è≥ Video stalled');
                });

                // Waiting event
                this.videoPlayer.addEventListener('waiting', () => {
                    console.log('‚è≥ Video waiting for data');
                    this.updateDebugLog('‚è≥ Video waiting for data');
                });

                // Can play event
                this.videoPlayer.addEventListener('canplay', () => {
                    console.log('‚úÖ Video can play');
                    this.updateDebugLog('‚úÖ Video can play');
                });

                // Can play through event
                this.videoPlayer.addEventListener('canplaythrough', () => {
                    console.log('‚úÖ Video can play through');
                    this.updateDebugLog('‚úÖ Video can play through');
                });

                // Time update event (throttled)
                let lastTimeUpdate = 0;
                this.videoPlayer.addEventListener('timeupdate', () => {
                    if (this.isTracking) {
                        const currentTime = this.videoPlayer.currentTime;
                        const duration = this.videoPlayer.duration;
                        
                        // Only log every second to avoid spam
                        if (Math.floor(currentTime) !== lastTimeUpdate) {
                            lastTimeUpdate = Math.floor(currentTime);
                            console.log(`‚è±Ô∏è Video time: ${currentTime.toFixed(1)}s / ${duration.toFixed(1)}s`);
                            this.updateDebugLog(`‚è±Ô∏è Video time: ${currentTime.toFixed(1)}s / ${duration.toFixed(1)}s`);
                        }
                    }
                });
            }

            onVideoEnded() {
                console.log('üèÅ Video playback completed');
                this.updateDebugLog('üèÅ Video playback completed');
                this.isTracking = false;
                
                // Stop Morphcast tracking
                if (this.morphcastInstance && this.morphcastInstance.stop) {
                    this.morphcastInstance.stop();
                    console.log('üõë Morphcast tracking stopped');
                    this.updateDebugLog('üõë Morphcast tracking stopped');
                }
                
                // Show completion
                this.showStep(5);
                this.updateDebugLog('‚úÖ Study completed successfully');
            }

            async testVideoOnly() {
                try {
                    console.log('üî¨ Testing video playback only (no Morphcast)...');
                    this.updateDebugLog('üî¨ Testing video playback only...');
                    
                    // Show video
                    this.videoPlayer.style.display = 'block';
                    this.setupVideoEventListeners();
                    
                    // Test video play without Morphcast
                    console.log('üé¨ Attempting to play video...');
                    this.updateDebugLog('üé¨ Attempting to play video...');
                    
                    const playPromise = this.videoPlayer.play();
                    
                    if (playPromise !== undefined) {
                        await playPromise;
                        console.log('‚úÖ Video test successful');
                        this.updateDebugLog('‚úÖ Video test successful');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Video test failed:', error);
                    this.updateDebugLog('‚ùå Video test failed: ' + error.message);
                }
            }

            showStep(stepNumber) {
                console.log('üìÑ Showing step:', stepNumber);
                this.updateDebugLog('üìÑ Showing step: ' + stepNumber);
                
                // Hide all steps
                for (let i = 1; i <= 5; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (step) {
                        step.classList.remove('active');
                    }
                }
                
                // Show target step
                const targetStep = document.getElementById(`step${stepNumber}`);
                if (targetStep) {
                    targetStep.classList.add('active');
                    this.currentStep = stepNumber;
                }
                
                // Hide error
                this.hideError();
            }

            showError(message) {
                console.error('üí• Error:', message);
                this.updateDebugLog('üí• Error: ' + message);
                
                const errorDisplay = document.getElementById('errorDisplay');
                if (errorDisplay) {
                    errorDisplay.textContent = message;
                    errorDisplay.style.display = 'block';
                }
                
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) {
                    retryBtn.style.display = 'block';
                }
            }

            hideError() {
                const errorDisplay = document.getElementById('errorDisplay');
                if (errorDisplay) {
                    errorDisplay.style.display = 'none';
                }
                
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) {
                    retryBtn.style.display = 'none';
                }
            }

            copyCompletionCode() {
                const code = config.COMPLETION_CODE;
                navigator.clipboard.writeText(code).then(() => {
                    console.log('üìã Code copied to clipboard');
                    this.updateDebugLog('üìã Code copied');
                    alert('Completion code copied to clipboard!');
                }).catch(err => {
                    console.error('‚ùå Failed to copy code:', err);
                    this.updateDebugLog('‚ùå Copy failed');
                    alert('Please manually copy the code: ' + code);
                });
            }

            retry() {
                console.log('üîÑ Retrying...');
                this.updateDebugLog('üîÑ Retrying...');
                
                // Reset tracking
                this.isTracking = false;
                this.trackingData = [];
                
                // Stop Morphcast if running
                if (this.morphcastInstance && this.morphcastInstance.stop) {
                    this.morphcastInstance.stop();
                }
                
                // Reset video
                if (this.videoPlayer) {
                    this.videoPlayer.pause();
                    this.videoPlayer.currentTime = 0;
                    this.videoPlayer.style.display = 'none';
                }
                
                // Go back to step 1
                this.showStep(1);
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM loaded, initializing app...');
            new EmotionTracker();
        });
    </script>
</body>
</html> 